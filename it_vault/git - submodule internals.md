___
В этой статье подробно рассматриваются следующие вопросы:
- как подмодули хранятся в репозитории
- как информация о подмодулях хранится в репозитории
- зачем нужно дублировать эту информацию в `git/config` и что значит флаг `active` 

___
### 1. Информация о подмодулях в репозитории

Сами подмодули в репозитории не хранятся. Хранится только вся необходимая информация, необходимая для скачивания нужного подмодуля.

Часть этой информации хранится в файле `<workdir>/.gitmodules`. Это файл имеет следующее содержимое:
```
[submodule "submodules/sub1"]
	path = submodules/sub1
	url = git@github.com:EKrukov1989/sub1.git
	branch = expand
...
```

Для каждого подмодуля указан `url`, откуда следует выкачивать подмодуль, а также `path` относительно `<workdir>`, куда этот подмодуль следует поместить.

`branch` - используется только при вызове команды `submodule update --remote`. При вызове этой команды подмодуль будут обновляться до коммита, на который в текущий момент указывает ветка `branch`. Это поле необязательно.

Кроме всей вышеперечисленной информации репозторий должен где-то хранить информацию о требуемом коммите подмодуля. К сожалению, получить эту информацию немного сложнее.

Допустим наш подмодуль находится по пути `submodules/sub1` и нас интересует ветка суперпроекта `natural`. Тогда можно найти этот коммит следующим образом:
```bash
git cat-file -p natural^{tree}

Вывод:
100644 blob a79f0b78b54dc4b19d47eff8e1c49836bde57815	.gitmodules
100644 blob ba3cdc577941c636e4393f3d35115b7b2c0e4305	file_a
100644 blob e69de29bb2d1d6434b8b29ae775ad8c2e48c5391	file_f
040000 tree 6ac94ac7f461ccdec7eb75753b496600aff655a8	submodules
```

Теперь можно посмотреть что находится в дерево `submodules`:
```bash
git cat-file -p 6ac94ac7f461ccdec7eb75753b496600aff655a8

Вывод:
160000 commit a7ebc83dbd6039d18cb00ec23513c3b60feaf5ed	sub1
```
Последний хэш-код - это и есть хэш-код коммита, который установлен для данного подмодуля.

___
### 2. Что из себя представляют модули в рабочей директории

Если склонировать проект, который содержит подмодуль по пути `submodules/sub1`, то непосредственно после клонирования папка `submodules/sub1` будет существовать и будет пуста. Нужно выполнить команды:
```bash
git submodule init
git submodule update
```
В результате все содержимое из репозитории подмодуля будет склонировано в папку `submodules/sub1` и будет выполнен `checkout` этого репозитория на нужный коммит.

Этим репозиторием можно пользоваться как обычным репозиторием git, хотя он имеет некоторые отличия. Внутри репозитория подмодуля отсутствует папка `.git`, а вместо нее присутствует файл `.git`, которые содержит путь к соответствующей папке `.git` внутри папки `.git` суперпроекта.

___
### 3. Информация о подмодулях в суперпроекте

Файл `.gitmodules` хранит информацию о состоянии подмодулей для общего пользования, которая распространяется вместе с репозиторием. В то же время локально в рабочей директории пользователь может иметь несколько другие настройки. Для этого информация их `.gitmodules` копируется в файл `.git/config`. Рассмотрим этот процесс последовательно.

##### Шаг 1.
```bash
git clone ...
```
Клонируем репозиторий, который модержит подмодуль `submodules/sub1`.
На этом этапе папка `submodules/sub1` пуста, репозиторий не склонирован, в файле `.git/config` отсутствует какая-либо информация о субмодулях.
##### Шаг 2.
```bash
git submodule init
```
В файлt `.git/config` появляется следующая запись:
```
[submodule "submodules/sub1"]
	active = true
	url = git@github.com:EKrukov1989/sub1.git
```
Папка `submodules/sub1` все еще пуста.
##### Шаг 3.
```bash
git submodule update
```
Подмодуль будет склонирован и приведен в нужное состояние.
##### Шаг 4.
```bash
git submodule deinit -- submodules/sub1
```
Папка `submodules/sub1` будет очищена, вся информация о подмодуле `submodules/sub1` будет вычищена из `.git/config`.

Таким образом с помощью команд init и deinit можно выбирать какие сабмодули следует использовать, а какие - нет.
