iptables - это утилита для управления системой netfilter.

>[!warning] iptables только для пакетов IPv4. Для IPv6 - ip6tables.

### 1. Основные понятия и общее представление

iptables состоит из нескольких независимых таблиц (tables). Сейчас таблиц пять: filter, nat, mangle, raw, security. Заострять на этом внимание не стоит, так как на самом деле таблицы это просто способ организации цепочек, причем не самый удачный.

Таблицы состоят из цепочек (chains). 
Любую таблицу вместе со всеми цепочками можно вывести на экран с помощью команды: `sudo iptables -t <table_name> -L`. Вывод таблицы выглядит примерно вот так:

```
(таблица приведена только для описания структуры и довольно бессмыслена)

Chain INPUT (policy DROP)
target       prot opt source               destination
ACCEPT       all  --  anywhere             anywhere   
DROP         all  --  anywhere             anywhere   
user-chain   all  --  anywhere             anywhere   

Chain FORWARD (policy DROP)
target       prot opt source               destination

Chain OUTPUT (policy ACCEPT)
target       prot opt source               destination

Chain user-chain (1 references)
target       prot opt source               destination
ACCEPT       all  --  anywhere             anywhere
```

Цепочка это упорядоченная последовательность правил (rules) + политика по умолчанию (chain policy).
Каждая цепочка применяются к пакету на определенном этапе его обработки. Обычно этап соответствует имени цепочки. Например, таблица nat имеет следующие встроенные цепочки: `PREROUTING, INPUT, OUTPUT, POSTROUTING`.

>[!note] Имена таблиц - всегда в нижнем регистре, имена встроенных цепочек - всегда в верхнем регистре.

В процессе выполнения цепочки пакет проверяется и выносится вердикт - пропустить пакет или выбросить.

Правило (rule) состоит из критериев (criteria) и цели (target).
Если пакет соответствует критерию, то выполняется цель. Если нет - применяется следующее правило в цепочке.

Цели могут быть следующими:
- `ACCEPT` -> пропустить пакет
- `DROP` -> выбросить пакет, как будто ничего не было получено
- `RETURN` -> завершить выполнение текущей цепочки и возобновить выполнение родительской цепочки
- `JUMP` -> перейти к выполнению пользовательской цепочки

Если процесс выполнения дошел до конца стандартной цепочки, то выполняется политика по умолчанию. Политика по умолчанию может иметь одно из значений - `ACCEPT, DROP, REJECT`.

### 2. Connection tracking

Для лучшей фильтрации нужно знать тип пакета. Например таблица NAT просматривает только пакеты, которые создают новое соединение.

conntrack определяет состояние пакета. Которых всего может быть четыре:
- `NEW` -> пакет открывает новый сеанс
- `ESTABLISHED` -> пакет является часть существующего сеанса
- `RELATED` -> открывает новый сеанс, связанный с уже существующим сеансом
- `INVALID` -> все прочие

### 3. Типы таблиц

Сейчас есть пять типов таблиц. Однако, большинство из них слишком специфические, поэтому имеет смысл описать их вкратце:
- `filter` -> таблица по умолчанию, с помощью которой можно реализовать большую часть всех нужных фильтров
- `mangle` -> содержит правила модификации IP-пакетов
- `nat` -> просматривает пакеты, которые создают новое соединение
- `raw, security` - совсем специфические таблицы

Порядок обработки пакета изображен на схеме:
`(схема неполная, например здесь нет таблицы security)`
![[400px-Netfilter-diagram-rus.png]]

>[!note]
>Некоторые цепочки из разных таблиц имеют одинаковые имена, но это разные цепочки и они действуют независимо друг от друга.

### 4. Манипуляции с таблицами

Подробно разбирать команды нет смысла, вот краткий обзор, для понимая функционала:

Синтаксис команд в общем виде примерно такой:
`iptables [-t table] [command] chain [rulenum] [rule-spec] [options]` 

`-t` -> указать таблицу, по умолчанию - filter

Команды:
``-A, --append chain rule-specification` 
- добавить правило в конец выбранной цепочки
`-C, --check chain rule-specification`
- проверить есть ли правило с такой спецификацей в выбранной цепочке
`-D, --delete chain rule-specification`
- удалить правило в выбранной цепочке
`-I, --insert chain [rulenum] rule-specification`
- вставить правило в цепочку соответствующим номером
`-R, --replace chain rulenum rule-specification`
- заменить правило
`-L, --list [chain]`
- вывести все правила в выбранной цепочке, если цепочка не указана - вывести всю таблицу
`S, --list-rules [chain]`
- Примерно то же, что и предыдущее
`-N, --new-chain chain`
- создать новую пользовательскую цепочку
`-X, --delete-chain [chain]`
- удалить цепочку
`-P, --policy chain target`
- поставить политику по умолчанию
`-E, --rename-chain old-chain new-chain`
- переименовать пользовательскую цепочку
`-m, --match match`
- установить критерий для правила
`-j, --jump target`
- установить цель для правила

>[!tip]
>Статья получилась обзорной.
>Iptables очень обширная тема и чтобы пользоваться ей или даже разбирать нормально существующие таблицы - нужно копать значительно глубже.

