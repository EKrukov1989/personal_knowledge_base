___
### 1. Процесс установки ssh-соединения

Рассмотрим процесс установки ssh-соединения с помощью пары ключей.

В процессе установки соединения принимают участие:
- `user_pc` -> машина пользователя
- `remote_pc` -> удаленная машина
- `client` -> ssh-клиент, запущенный на `user_pc`
- `daemon` -> sshd, запущенный на `remote_pc`
- `user_pub_key`, `user_priv_key` -> пара ключей на `user_pc`
- `remote_pub_key`, `remote_priv_key` -> пара ключей на `remote_pc`

Упрощенное описание процесса:

#####  Шаг 1
- Пользователь вводит в терминале команду:
`ssh -l <remote_pc_login> <remote_pc_IP>`.
- `client` посылает `daemon` сообщение с просьбой о ssh-подключении.
В этом сообщении указаны `remote_pc_login` и `user_pub_key`

#####  Шаг 2
- `daemon` получает сообщение и проверяет что `user_pub_key` добавлен в `/home/remote_pc_login/.ssh/authorized_keys`.
- Затем `daemon` генерирует случайную строку, шифрует ее с помощью `user_pub_key` и отправляет полученный результат клиенту.
- Заодно `daemon` отправляет свой ключ - `remote_pub_key`.

#####  Шаг 3
- `client` получает `remote_pub_key` и проверяет что `remote_pub_key` добавлен в  ли `/home/user_pc_login/.ssh/known_hosts`. Если не добавлен, то вычисляет его fingerprint и спрашивает пользователя, готов ли он доверять этому хосту.
- Клиент расшифровывает присланную ему случайную строку своим приватным ключом, добавляет к результату session ID, вычисляет MD5-хэш и отправляет обратно `daemon`'у.

#####  Шаг 4
Сервер проверяет полученный хэш и если он совпадает с хэшем, который вычислен локально, то пользователь будет успешно аутентифицирован.

# *
В этом описании внимание сосредоточено на том, как демон проверяет принадлежность `user_pub_key`, однако параллельно клиент аналогичным образом проверяет принадлежность `remote_pub_key`.

___
### 2. Описание элементов инфраструктуры

##### 2.1. Authorized_keys

- текстовый файл, который находится на `remote_pc` по адресу `/home/remote_pc_login/.ssh/authorized_keys`.
- В этом файле прописаны все публичные ключи, владельцам которых разрешен доступ к данному аккаунту.
- Каждый ключ записан на отдельной строке.

##### 2.2. Known_hosts

- текстовый файл, который находится на `user_pc` по адресу `/home/user_pc_login/.ssh/known_hosts`.
- В этом файле прописаны все публичные ключи и имена хостов, к которым ранее было осуществлено подключение (даже если подключение было совершено с помощью пароля).
- Каждый ключ записан на отдельной строке.

##### 2.3. User keys

- `user_pub_key`, `user_priv_key` пользователь создает сам с помощью ssh-keygen
- user keys хранятся на машине пользователя в директории `/home/user_pc_login/.ssh/`. При попытке установить соединение ssh может использовать любые ключи из этой папки.
- при подключении через ssh можно указать конкретный ключи (или ключи) с помощью опции `-i`.

##### 2.4. Remote keys

- remote keys хранятся в директории `/etc/ssh/` и эти ключи принадлежат не какому-то определенному пользователю, а всей системе. Также называются host keys.
- эти ключи генерировать не нужно, они генерируются при установке системы
- системы создает пары ключей сразу для нескольких алгоритмов ассиметричного шифрования: dsa, ecdsa, ed25519 и rsa.
- в `/etc/ssh/sshd_config` можно добавить ключи, которые следует использовать в качестве host keys

___
### 3. Режимы доступа

Все элементы этой инфраструктуры должны быть соответствующим образом защищены. Чтобы никто кроме владельца не мог изменять их, а некоторых случаях даже читать.

Права доступа должны быть выставлены следующим образом:

режим|файлы и директории
-|-
`drwxr-x---`|`/home/user_pc_login`
`drwx------`|`/home/user_pc_login/.ssh`
`-rw-r--r--`|для всех публичных ключей
`-rw-------`|`/home/user_pc_login/.ssh/authorized_keys`
`-rw-------`|`/home/user_pc_login/.ssh/known_hosts`
`-rw-------`| для всех приватных ключей

___
### 4. Ключи для аутентификации и подписи

Обычная практика, когда пользователь обладает двумя парами ключей: `authentication key pair` и `signing key pair`. Рассмотрим механизсы аутентификации и подписи:

Допустим у Юзера есть пара ключей - ПРИВ и ПУБ.

Процесс аутентификации Юзера будет проходить следующим образом:
- мы шифруем случайную строку его ключом ПУБ и посылаем результат ему.
- Юзер расшифровывает строку своим ключом ПРИВ и отправляет результат нам.
- Если полученная строка совпала с той, что нам прислали - значит Юзер является настоящим владельцем этого ключа ПУБ.

Процесс подписи некоего ТЕКСТ будет проходить следующим образом:
- Юзер шифрует ТЕКСТ своим ключом ПРИВ
- теперь любой у кого есть ключ ПУБ, может проверить удостовериться в подлинности подписи, потому что только Юзер мог зашифровать ТЕКСТ так, чтобы его расшифровывал ПУБ.

Т.е. в паре ключей для аутентификации публичный ключ - для шифрования, а в подписи - наоборот.

Второе отличие заключается в том, что пара ключей для аутентификации может иметь копию, которая храниться на каком-то специальном сервисе. Пользователь в случае утери приватного ключа сможет обратить к этому сервису и восстановить пару ключей для аутентификации. Это важно, потому что в противном случае некоторые данные, переданные пользователю могут быть безвозвратно утеряны.
Ключи для подписи хранятся только у Юзера, потому что в противном случае он может попробовать отказаться от подписанных документов.


___
### 5. Практика хранения ключей

Допустим на машине у меня есть две пары ключей:
- пара для аутентификации
- пара для подписи

В процессе работы я добавлю публичный ключ для аутентификации на несколько машин. В случае утери пары для аутентификации все эти машины окажутся недоступными.

>[!tip]
>Пара ключей для аутентификации и пассфрейз к ним должны быть скопированы и сохранены в безопасном месте.

Пару ключей для подписи сохранять необязательно. В случае чего их можно просто перевыпустить.








