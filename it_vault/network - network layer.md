### 1. Зачем нужен межсетевой уровень

На межсетевом уровне передают и принимают пакеты. Важнешим отличием этого уровня является то, что пакеты могут передаваться по глобальной сети, в том числе через сети различного типа. А это значит:
- количество хостов в сети может быть очень велико, а коммутаторы не смогут работать эффективно при боольшом количестве хостов
- пакет в процессе путешествия к точке назначения может передаваться с помощью разных протоколов канального уровня

Чтобы разные сети могли соединяться друг с другому, необходимо, чтобы они поддерживали один стандарт и таким стандартом стал IPv4.

>[!note]
>Еще есть стандарт [[network - IPv6]], но для понимания работы межсетевого уровня можно ограничиться IPv4.

У каждого сетевого интерфейса в сети должен быть уникальный адрес.
В целом MAC-адрес должен быть уникальным, но MAC-адрес относиться к канальному уровню и никто не гарантирует, что в каждой сети он должен быть. Поэтому для идентификации в глобальной сети используется IP-адрес.

>[!note]
>Будем считать что у всех хостов (сетевых интерфейсов) в сети уникальные IPv4-адреса. На самом деле существует [[network - NAT]], но с точки зрения понимания работы межсетевого уровня это ничего не меняет.

### 2. Представление о сети на межсетевом уровне

В глобальной сети очень много хостов, которые разбросаны по всему миру. Поэтому для того, чтобы отправить пакет по определенному IP-адресу нужно сначала каким-то образом определить маршрут для передачи этого пакета и широковещание здесь уже использовать не получится. Для решения этой задачи были придуманы маршрутизаторы.

На сетевом уровне сеть можно представить следующим образом:
![[routing_scheme.png]]
В каждой локальной сети есть маршрутизатор, который соединен с другими маршрутизаторами в сети. Для того, чтоб отправить пакет на хост в другой локальной сети нужно сначала рассчитать маршрут.

Есть много алгоритмов маршрутизации и они довольно сложные. Главное что нужно знать про маршрутизаторы:
- маршрутизаторы общаются между собой с помощью специальных протоколов, чтобы определять маршруты
- у каждого маршрутизатора есть IP-адрес или даже несколько IP-адресов
- IP-адресация имеет иерархический характер, поэтому для всех хостов, которые прикреплены к одному маршрутизатору, выделен непрерывный блок адресов

### 3. Особенности протокала IPv4

Особенности передачи пакетов на сетевом уровне:
- пакеты передаются без установления соединения
- при приеме пакета подтверждение не высылается
>[!note]
>То есть пакеты в сети - это датаграммы. Хотя существует технология MPLS, которая позволяет устанавливать что-то вроде соединения.
- размер IP-пакета можент достигать 65 515 байт.
- пакет может быть разбит на фрагменты и отправлен по частям
- фрагменты могут добираться по пункта назначения разными путями

Для того, чтобы пакет можно было собрать из фрагментов в пакете IPv4 ([[network - IPv4 packet structure]]) предусмотрены следующие заголовки:
- total length - длина пакета в байтах (максимум - 65535 байт)
- identification - идентификатор датаграммы
- fragment offset - смещение фрагмента, относительно начала датаграммы

Сетевой уровень ответственен как за разбиение пакета на фрагменты так и за сборку пакета из фрагментов. 

Помимо перечисленных внимания заслуживают следующие заголовки:
- source and destination IP-addresses - конечно
- protocol - протокол транспортного уровня, для которого предназначен пакет (TCP, UDP, и т.д. ). Что уже нарушает разделение на уровни.

### 4. Передача пакета на канальном уровне

В интернете пакете пересылаются с одного IP-адреса на другой, но для того, чтобы передать пакет на канальном уровне надо знать MAC-адрес назначения. Для решения этой задачи был придуман протокол [[network - ARP]].
Этот протокол позволяет по известному IP-адресу найти MAC-адрес назначения, или если пункт назначения находится в другой ЛВС - MAC-адрес маршрутизатора.

С собственным хостом все наоборот. Мы знаем MAC-адрес и не знаем своего IP-адреса. Его можно либо назначить, либо воспользоваться протоколом [[network - DHCP]]. Этот протокол выделит IP-адрес и другую нужную информацию.






